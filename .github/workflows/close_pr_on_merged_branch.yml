name: Close platform PR after merge

on:
  repository_dispatch:
    types:
      - cf-reeve-platform-pr-merged

jobs:
  close-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents:  read
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Skip protected branches
        id: check_branch
        env:
          SOURCE_BRANCH: "${{ github.event.client_payload.sourceBranch }}"
        run:  |
          if [[ "$SOURCE_BRANCH" == "main" || "$SOURCE_BRANCH" == "release/"* ]]; then
            echo "Protected branch $SOURCE_BRANCH â€“ skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name:  Close PR
        if: steps.check_branch.outputs.skip != 'true'
        run: |
          echo "Closing PR #$PR_NUMBER for branch $SOURCE_BRANCH"
          gh pr close $SOURCE_BRANCH \
            --repo ${{ github.repository }} \
            --comment "Closed automatically because the platform PR was merged."
