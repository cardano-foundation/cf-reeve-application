name: Sync platform versions

on:
  repository_dispatch:
    types: 
     - cf-reeve-platform-pr

jobs:
  create-or-update-pr:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    permissions: 
      pull-requests: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update platform version
        run: |
          VERSION="${{ github.event.client_payload.TRIGGERING_PAYLOAD.version }}"
          PR_NAME="${{ github.event.client_payload.TRIGGERING_PAYLOAD.prName }}"
          SOURCE_BRANCH="${{ github.event.client_payload.TRIGGERING_PAYLOAD.sourceBranch }}"
          TARGET_BRANCH="${{ github.event.client_payload.TRIGGERING_PAYLOAD.targetBranch }}"

          echo "Checkout branch $SOURCE_BRANCH"
          if ! git checkout $SOURCE_BRANCH 
          then
            echo "Branch does not exist. Creating new branch $SOURCE_BRANCH"
            git checkout -b $SOURCE_BRANCH
          fi
          echo "Check if PR for branch $SOURCE_BRANCH exists"
          if ! gh pr view $SOURCE_BRANCH > /dev/null
          then
            echo "PR does not exist. Creating new PR \"$PR_NAME\" from $SOURCE_BRANCH to $TARGET_BRANCH"
            gh pr create --title "$PR_NAME" --body "" --base $TARGET_BRANCH --head $SOURCE_BRANCH
          fi
          gh pr checkout $SOURCE_BRANCH

          echo "Pull latest changes"
          git pull

          echo "Set platform version to $VERSION"
          sed -i -E "s|extra\[\"cfLobPlatformVersion\"\] = \".*\"|extra\[\"cfLobPlatformVersion\"\] = \"$VERSION\"|g" build.gradle.kts

          echo "Commit and push new platform version"
          git add build.gradle.kts
          git commit -m "chore: bump platform version"
          git push --dry-run
