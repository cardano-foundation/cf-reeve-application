name: Close platform PR after merge

on:
  repository_dispatch:
    types:
      - cf-reeve-platform-pr-merged
  push:
    branches:
      - feat/LOB-1866-BE-Close-reeve-application-PRs-from-gha-trigger
jobs:
  close-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    env:
      GH_TOKEN: ${{ secrets.CF_REEVE_APPLICATION_REPO_PAT }}

    steps:
      - name: Extract branch
        run: |
          # echo "SOURCE_BRANCH=${{ github.event.client_payload.sourceBranch || github.event.inputs.sourceBranch }}" >> $GITHUB_ENV
          echo "SOURCE_BRANCH=chore/test-pr-deletion-workflow" >> $GITHUB_ENV
      - name: Skip protected branches
        run: |
          if [[ "$SOURCE_BRANCH" == "main" || "$SOURCE_BRANCH" == release/* ]]; then
            echo "Protected branch $SOURCE_BRANCH â€“ skipping"
            exit 0
          fi

      - name: Find PR by branch
        id: find_pr
        run: |
          PR_NUMBER=$(gh pr list \
            --state open \
            --head "$SOURCE_BRANCH" \
            --json number \
            --jq '.[0].number')

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

      - name: Close PR
        if: env.PR_NUMBER != ''
        run: |
          echo "Closing PR #$PR_NUMBER for branch $SOURCE_BRANCH"
          gh pr close "$PR_NUMBER" --comment \
            "Closed automatically because the platform PR was merged."
