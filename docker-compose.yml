services:

  postgres:
    image: postgres:16.3
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - lob

  publisher:
    build:
      context: .
    env_file: cf-application/.env
    environment:
      KEYCLOAK_ENABLED: true
      # Only used for dev and mocking netsuit
      LOB_MOCK_RESULT_PATH: /app/cf-application/src/main/resources/json/NetSuiteIngestionMock.json
      SPRING_CONFIG_LOCATIONS: classpath:/application.yml,classpath:/application-dev--yaci-dev-kit.yml
      SPRING_PROFILES_ACTIVE: dev--yaci-dev-kit
      DB_URL: ${DB_USER:-jdbc:postgresql://postgres:5432/postgres}
      KC_BASE_URL: ${KC_BASE_URL:-http://keycloak:8080}
      lob_owner_account_mnemonic: ${LOB_OWNER_ACCOUNT_MNEMONIC:-ocean sad mixture disease faith once celery mind clay hidden brush brown you sponsor dawn good claim gloom market world online twist laptop thrive}
      LOB_ACCOUNTING_REPORTING_CORE_ENABLED: false
      LOB_ORGANISATION_ENABLED: false
      LOB_BLOCKCHAIN_READER_ENABLED: true
      LOB_BLOCKCHAIN_PUBLISHER_ENABLED: true
      LOB_NETSUITE_ENABLED: true
      SERVER_PORT: 9001
      LOB_BLOCKFROST_URL: http://yaci-cli:8081/api/v1/
      LOB_BLOCKCHAIN_READER_LOB_FOLLOWER_BASE_URL: http://follower-app:9090/api
      SPRING_KAFKA_ENABLED: true
    working_dir: /app
    entrypoint: ${ENTRYPOINT:-java --enable-preview -jar /app.jar}
    networks:
      - lob
    ports:
      - "9001:9001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backendhttp.entrypoints=web"
      - "traefik.http.routers.backendhttp.rule=Host(`${APP_BACK_HOSTNAME:-dev.api.cf-lob.metadata.dev.cf-deployments.org}`)"
      - "traefik.http.routers.backend.rule=Host(`${APP_BACK_HOSTNAME:-dev.api.cf-lob.metadata.dev.cf-deployments.org}`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=myresolver"
      - "traefik.http.middlewares.https-redirect.headers.customrequestheaders.X-Forwarded-Proto=https"
    volumes:
      - ./:/app/
  api:
    build:
      context: .
    env_file: cf-application/.env
    environment:
      KEYCLOAK_ENABLED: true
      # Only used for dev and mocking netsuit
      LOB_MOCK_RESULT_PATH: /app/cf-application/src/main/resources/json/NetSuiteIngestionMock.json
      SPRING_CONFIG_LOCATIONS: classpath:/application.yml,classpath:/application-dev--yaci-dev-kit.yml
      SPRING_PROFILES_ACTIVE: dev--yaci-dev-kit
      DB_URL: ${DB_USER:-jdbc:postgresql://postgres:5432/postgres}
      KC_BASE_URL: ${KC_BASE_URL:-http://keycloak:8080}
      lob_owner_account_mnemonic: ${LOB_OWNER_ACCOUNT_MNEMONIC:-ocean sad mixture disease faith once celery mind clay hidden brush brown you sponsor dawn good claim gloom market world online twist laptop thrive}
      LOB_ACCOUNTING_REPORTING_CORE_ENABLED: true
      LOB_ORGANISATION_ENABLED: true
      LOB_BLOCKCHAIN_READER_ENABLED: false
      LOB_BLOCKCHAIN_PUBLISHER_ENABLED: false
      LOB_NETSUITE_ENABLED: false
      SPRING_KAFKA_ENABLED: true
      SERVER_PORT: 9000
    working_dir: /app
    entrypoint: ${ENTRYPOINT:-java --enable-preview -jar /app.jar}
    networks:
      - lob
    ports:
      - "9000:9000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backendhttp.entrypoints=web"
      - "traefik.http.routers.backendhttp.rule=Host(`${APP_BACK_HOSTNAME:-dev.api.cf-lob.metadata.dev.cf-deployments.org}`)"
      - "traefik.http.routers.backend.rule=Host(`${APP_BACK_HOSTNAME:-dev.api.cf-lob.metadata.dev.cf-deployments.org}`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=myresolver"
      - "traefik.http.middlewares.https-redirect.headers.customrequestheaders.X-Forwarded-Proto=https"
    volumes:
      - ./:/app/

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    command: start-dev --import-realm
    networks:
      - lob
    environment:
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KC_BOOTSTRAP_ADMIN_PASSWORD:-admin}
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KC_BOOTSTRAP_ADMIN_USERNAME:-admin}
      KC_METRICS_ENABLED: ${KC_METRICS_ENABLED:-true}
      KC_HEALTH_ENABLED: ${KC_HEALTH_ENABLED:-true}
      KC_HOSTNAME: ${KC_HOSTNAME-localhost}
      KC_IMPORT: ${KC_IMPORT:-/opt/keycloak/data/import/realm-export.json}
      KC_HTTP_ENABLED: true
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_PORT: ${KC_HTTP_PORT:-8080}
      KC_HTTPS_PORT: ${KC_HTTP_PORT:-8443}
      KC_DB: ${KC_DB:-postgres}
      KC_DB_URL_HOST: ${KC_DB_URL_HOST:-postgres}
      KC_DB_URL_PORT: ${KC_DB_URL_PORT:-5432}
      KC_DB_USERNAME: ${KC_DB_USERNAME:-postgres}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD:-postgres}
    ports:
      - ${EXPOSED_KC_HTTP_PORT:-8080}:${KC_HTTP_PORT:-8080}
      - ${EXPOSED_KC_HTTPS_PORT:-8443}:${KC_HTTPS_PORT:-8443}
#      - ${EXPOSED_KC_HEALTH_PORT:-8081}:9000
    volumes:
      - ./keycloak-config:/opt/keycloak/data/import
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloakhttp.entrypoints=web"
      - "traefik.http.routers.keycloakhttp.rule=Host(`${KC_HOSTNAME:-dev.keycloak.cf-lob.metadata.dev.cf-deployments.org}`)"
      - "traefik.http.routers.keycloak.rule=Host(`${KC_HOSTNAME:-dev.keycloak.cf-lob.metadata.dev.cf-deployments.org}`)"
      - "traefik.http.routers.keycloak.entrypoints=websecure"
      - "traefik.http.routers.keycloak.tls.certresolver=myresolver"
      - "traefik.http.middlewares.https-redirect.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.services.keycloak.loadbalancer.server.port=${KC_HTTP_PORT:-8080}"

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    networks:
      - lob
    restart: always
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181

  kafka:
    image: confluentinc/cp-kafka:latest
    networks:
      - lob
    restart: always
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true

  follower-app:
    image: pro.registry.gitlab.metadata.dev.cf-deployments.org/base-infrastructure/docker-registry/cf-lob-follower-app:main-cfdc341-GHRUN13132112940
    networks:
      - lob
    ports:
      - "9090:9090"
    environment:
      SPRING_PROFILES_ACTIVE: dev--yaci-dev-kit
      DB_URL: ${DB_USER:-jdbc:postgresql://postgres:5432/postgres?currentSchema=lob_follower_service}
      LOB_BLOCKFROST_URL: http://yaci-cli:8081/api/v1/
      STORE_CARDANO_HOST: yaci-cli
      SOTRE_CARDANO_PORT: 3001
      STORE_CARDANO_PROTOCOL_MAGIC: 42

  yaci-cli:
    image: bloxbean/yaci-cli:0.10.0-preview5
    networks:
      - lob
    env_file:
      - ./yaci-config/env
      - ./yaci-config/node.properties
    volumes:
      - ./yaci-config/node.properties:/app/node.properties
    ports:
      - "3001:3001"
      - "8081:8080"
      - "5173:5173"
    entrypoint: [ "/app/yaci-cli", "create-node", "-o", "--start" ]

volumes:
  postgres-data:

networks:
  lob:
    name: lob
